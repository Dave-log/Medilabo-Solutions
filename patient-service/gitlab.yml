cache:
  paths:
    - patient-service/target

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_TAG: $CI_REGISTRY_IMAGE/patient-service:$CI_COMMIT_SHA

compile_patient:
  stage: compile
  script:
    - mvn $MAVEN_CLI_OPTS clean compile -pl patient-service
  rules:
    - changes:
        - patient-service/**

test_patient:
  stage: test
  script:
    - mvn $MAVEN_CLI_OPTS test -pl patient-service
  rules:
    - changes:
        - patient-service/**

package_patient:
  stage: package
  script:
    - mvn $MAVEN_CLI_OPTS package -pl patient-service
  artifacts:
    paths:
      - patient-service/target/patient-service-0.0.1-SNAPSHOT.jar
  rules:
    - changes:
        - patient-service/**

docker_build_patient:
  image: docker:27.1.1-dind-alpine3.20
  stage: docker_build
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image with tag $IMAGE_TAG"
    - docker build -t $IMAGE_TAG -f patient-service/Dockerfile .
    - echo "Docker images lists:"
    - docker images
    - docker push $IMAGE_TAG
  rules:
    - changes:
        - patient-service/**

#docker_push_patient:
  #  image: docker:27.1.1-dind-alpine3.20
  #stage: docker_push
    #services:
    #- docker:dind
    #script:
    #- echo "Pushing Docker image with tag $IMAGE_TAG"
    #- docker push $IMAGE_TAG
    #rules:
        # - changes:
        #- patient-service/**